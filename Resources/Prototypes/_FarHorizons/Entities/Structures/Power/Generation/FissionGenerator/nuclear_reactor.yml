# KS14: Made alot of changes here to base reactor logic. Have fun finding out what.

- type: entity
  id: BaseNuclearReactor
  parent: BaseStructure
  name: nuclear reactor
  description: Should you really be standing this close to that?
  components:
  - type: Sprite
    sprite: _FarHorizons/Structures/Power/Generation/FissionGenerator/nuclear_reactor.rsi
    layers:
    - state: reactor
      visible: true
      map: [ "enum.ReactorVisualLayers.Sprite" ]
    - state: reactor_status_active
      visible: false
      shader: unshaded
      map: [ "enum.ReactorVisualLayers.Status" ]
    - state: reactor_gas_input_lights
      visible: false
      shader: unshaded
      map: [ "enum.ReactorVisualLayers.Input" ]
    - state: reactor_gas_output_lights
      visible: false
      shader: unshaded
      map: [ "enum.ReactorVisualLayers.Output" ]
    - state: reactor_lights_warning
      visible: false
      shader: unshaded
      map: [ "enum.ReactorVisualLayers.Lights" ]
    # - state: reactor_fire
    #   visible: false
    #   shader: unshaded
    #   map: [ "enum.ReactorVisualLayers.Smoke" ]
    # - state: reactor_smoke
    #   visible: false
    #   shader: unshaded
    #   map: [ "enum.ReactorVisualLayers.Fire" ]
  - type: GenericVisualizer
    visuals:
      enum.ReactorVisuals.Sprite:
        enum.ReactorVisualLayers.Sprite:
          Normal: { state: reactor }
          Melted: { state: reactorbroken }
      enum.ReactorVisuals.Status:
        enum.ReactorVisualLayers.Status:
          Off: { visible: false}
          Active: { state: reactor_status_active, visible: true }
          Overheat: { state: reactor_status_overheat }
          Meltdown: { state: reactor_status_meltdown }
          Boom: { state: reactor_status_boom }
      enum.ReactorVisuals.Input:
        enum.ReactorVisualLayers.Input:
          True: { visible: true }
          False: { visible: false }
      enum.ReactorVisuals.Output:
        enum.ReactorVisualLayers.Output:
          True: { visible: true }
          False: { visible: false }
      enum.ReactorVisuals.Lights:
        enum.ReactorVisualLayers.Lights:
          LightsOff: { visible: false }
          LightsWarning: { state: reactor_lights_warning, visible: true }
          LightsMeltdown: { state: reactor_lights_meltdown }
      # enum.ReactorVisuals.Smoke:
      #   enum.ReactorVisualLayers.Smoke:
      #     True: {visible: true}
      #     False: {visible: false}
      # enum.ReactorVisuals.Fire:
      #   enum.ReactorVisualLayers.Fire:
      #     True: {visible: true}
      #     False: {visible: false}
  - type: Appearance
  - type: Physics
    bodyType: Static
  - type: InteractionOutline
  - type: Transform
    noRot: true
  - type: Fixtures
    fixtures:
      fix1:
        shape:
          !type:PhysShapeAabb
          bounds: "-2.5,-2.5,2.5,2.5"
        density: 190
        mask:
        - MachineMask
        layer:
        - MachineLayer
  - type: Anchorable
    flags:
    - Anchorable

  # Reactor comps
  - type: NuclearReactor
    prefab: normal
    warningAlertSound:
      path: /Audio/_FarHorizons/Machines/alarm_beep.ogg
      params:
        loop: true
        volume: 1.1
    dangerAlertSound:
      path: /Audio/_KS14/Effects/warning_buzzer.ogg
      params:
        loop: true
        volume: 2
    manualSilenceSound:
      path: /Audio/_KS14/Effects/parking_button.ogg
      params:
        volume: 2

  - type: NodeContainer
    examinable: true
    nodes:
      inlet:
        !type:OffsetPipeNode
        nodeGroupID: Pipe
        pipeDirection: West
        volume: 1000
        offsetEast: -3
        offsetNorth: -1
      outlet:
        !type:OffsetPipeNode
        nodeGroupID: Pipe
        pipeDirection: East
        volume: 1000
        offsetEast: 3
        offsetNorth: 1
  - type: AtmosDevice
  - type: RadiationSource
    intensity: 0
  - type: ContainerContainer
    containers:
      part_slot: !type:ContainerSlot {}
  - type: ItemSlots
    slots:
      part_slot:
        whitelist:
          components:
            - ReactorPart

  # Guidebook
  - type: GuideHelp
    guides:
    - NuclearReactor
    - Power

  # Extra logic comps
  - type: AlertLevelChangeOnTrigger
    level: Yellow
    announce: false
    force: true

  # Explosive
  - type: Explosive
    explosionType: HardBomb
    intensitySlope: 1
    maxIntensity: 6
    tileBreakScale: 0.5
    canCreateVacuum: true

  # UI
  - type: ActivatableUI
    key: enum.NuclearReactorUiKey.Key
  - type: ActivatableUIRequiresAnchor
  - type: UserInterface
    interfaces:
      enum.NuclearReactorUiKey.Key:
        type: NuclearReactorBoundUserInterface

  # Access
  - type: AccessReader # You got a permit for that meltdown?
    access: [["Engineering"]]
  - type: Lock
    unlockOnClick: false

  # Sound
  - type: AmbientSound
    enabled: false
    volume: -6
    range: 12
    sound:
      path: /Audio/_KS14/Ambience/Objects/wind_plant_hum.ogg


# KS14 - Debug variant
- type: entity
  parent: BaseNuclearReactor
  id: NuclearReactorDebug
  suffix: Debug
  components:
  - type: NuclearReactor
    prefab: debug

# KS14 - Debug variant
- type: entity
  parent: BaseNuclearReactor
  id: NuclearReactorMeltdown
  suffix: Debug, Meltdown
  components:
  - type: NuclearReactor
    prefab: meltdown

# KS14 - Debug variant
- type: entity
  parent: BaseNuclearReactor
  id: NuclearReactorAlignment
  suffix: Debug, Alignment
  components:
  - type: NuclearReactor
    prefab: alignment

#Visual parts on the reactor
- type: entity
  id: ReactorComponent
  name: reactor component
  categories: [ HideSpawnMenu ]
  components:
  - type: Transform
    noRot: true
  - type: Tag
    tags:
    - HideContextMenu
  - type: Sprite
    sprite: _FarHorizons/Structures/Power/Generation/FissionGenerator/reactor_component_cap.rsi
    drawdepth: 1
    layers:
    - state: base_cap
      visible: true
      map: [ "enum.ReactorCapVisualLayers.Sprite" ]
  - type: GenericVisualizer
    visuals:
      enum.ReactorCapVisuals.Sprite:
        enum.ReactorCapVisualLayers.Sprite:
          Base: { state: empty_cap }
          Control: { state: control_cap }
          ControlM1: { state: control_cap_melted_1 }
          ControlM2: { state: control_cap_melted_2 }
          ControlM3: { state: control_cap_melted_3 }
          ControlM4: { state: control_cap_melted_4 }
          Fuel: { state: fuel_cap }
          FuelM1: { state: fuel_cap_melted_1 }
          FuelM2: { state: fuel_cap_melted_2 }
          FuelM3: { state: fuel_cap_melted_3 }
          FuelM4: { state: fuel_cap_melted_4 }
          Gas: { state: gas_cap }
          GasM1: { state: gas_cap_melted_1 }
          GasM2: { state: gas_cap_melted_2 }
          GasM3: { state: gas_cap_melted_3 }
          GasM4: { state: gas_cap_melted_4 }
          Heat: { state: heat_cap }
          HeatM1: { state: heat_cap_melted_1 }
          HeatM2: { state: heat_cap_melted_2 }
          HeatM3: { state: heat_cap_melted_3 }
          HeatM4: { state: heat_cap_melted_4 }
  - type: Appearance

# Nuclear debris resultant from a meltdown
- type: entity
  id: NuclearDebrisChunk
  parent: BaseItem
  name: metal chunk
  description: You did not see graphite on the roof. You're in shock. Report to medical.
  categories: [ HideSpawnMenu ]
  components:
  - type: Sprite
    sprite: Objects/Materials/Scrap/generic.rsi
    layers:
    - state: metal-1
      map: [ "base" ]
  - type: Item
    sprite: Objects/Materials/Scrap/generic.rsi
    size: Huge
  - type: MultiHandedItem
  - type: RandomSprite
    available:
    - base:
        metal-1: ""
        metal-2: ""
        metal-3: ""
  - type: RadiationSource
    intensity: 4.6
  - type: PointLight
    color: "#42a1eb"
    energy: 2
    radius: 1.5

# Arrow to indicate flow
- type: entity
  id: ReactorFlowArrow
  categories: [ HideSpawnMenu ]
  components:
    - type: Sprite
      sprite: Markers/teg_arrow.rsi
      color: "#FFFFFFBB"
      layers:
        - state: arrow
          rotation: 90
          offset: 2.75, 1
        - state: arrow
          rotation: 90
          offset: -2.75, -1
    - type: TimedDespawn
      lifetime: 2
    - type: Tag
      tags:
      - HideContextMenu

# Mapping prefab
- type: entity
  parent: BaseStructure
  id: NuclearReactorDestroyed
  name: destroyed nuclear reactor
  description: What a crisis. You should really get away from this.
  suffix: Mapping
  components:
  - type: Transform
    noRot: true
  - type: Physics
    bodyType: Static
  - type: Fixtures
    fixtures:
      fix1:
        shape:
          !type:PhysShapeAabb
          bounds: "-2.5,-2.5,2.5,2.5"
        density: 190
        mask:
        - MachineMask
        layer:
        - MachineLayer
  - type: Sprite
    sprite: _FarHorizons/Structures/Power/Generation/FissionGenerator/nuclear_reactor.rsi
    layers:
    - state: reactorbroken
      map: [ "enum.ReactorVisualLayers.Sprite" ]
  - type: InteractionOutline
  - type: RadiationSource
    intensity: 0
